"use strict";

var _fastify = _interopRequireDefault(require("fastify"));

var _rollbar = _interopRequireDefault(require("rollbar"));

var _path = _interopRequireDefault(require("path"));

var _dotenv = _interopRequireDefault(require("dotenv"));

var _pug = _interopRequireDefault(require("pug"));

var _fastifyStatic = _interopRequireDefault(require("fastify-static"));

var _fastifyFormbody = _interopRequireDefault(require("fastify-formbody"));

var _fastifyObjectionjs = _interopRequireDefault(require("fastify-objectionjs"));

var _pointOfView = _interopRequireDefault(require("point-of-view"));

var _models = _interopRequireDefault(require("./models"));

var _knexfile = _interopRequireDefault(require("../knexfile.js"));

var _index = _interopRequireDefault(require("./routes/index.js"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

_dotenv.default.config();

const rollbar = new _rollbar.default({
  accessToken: process.env.POST_SERVER_ITEM_ACCESS_TOKEN,
  captureUncaught: true,
  captureUnhandledRejections: true
}); //  app.use(rollbar.errorHandler());

rollbar.log('Hello world!');

const setUpViews = app => {
  app.register(_pointOfView.default, {
    engine: {
      pug: _pug.default
    },
    includeViewExtension: true,
    defaultContext: {
      assetPath: filename => `/assets/${filename}`
    }
  });
};

const setUpAssets = app => {
  app.register(_fastifyStatic.default, {
    root: _path.default.join(__dirname, '..', 'public'),
    prefix: '/assets/'
  });
};

const app = new _fastify.default({
  logger: true
});

const registerPlugins = app => {
  app.register(_fastifyFormbody.default);
  setUpViews(app);
  setUpAssets(app);
  app.register(_fastifyObjectionjs.default, {
    knexConfig: _knexfile.default.development,
    models: _models.default
  });
  app.register(_index.default);
};

registerPlugins(app);
app.listen(process.env.PORT || 3000, '0.0.0.0', (err, address) => {
  if (err) {
    app.log.error(err);
    process.exit(1);
  }

  app.log.info(`server listening on ${address}`);
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NlcnZlci9pbmRleC5qcyJdLCJuYW1lcyI6WyJkb3RlbnYiLCJjb25maWciLCJyb2xsYmFyIiwiUm9sbGJhciIsImFjY2Vzc1Rva2VuIiwicHJvY2VzcyIsImVudiIsIlBPU1RfU0VSVkVSX0lURU1fQUNDRVNTX1RPS0VOIiwiY2FwdHVyZVVuY2F1Z2h0IiwiY2FwdHVyZVVuaGFuZGxlZFJlamVjdGlvbnMiLCJsb2ciLCJzZXRVcFZpZXdzIiwiYXBwIiwicmVnaXN0ZXIiLCJwb2ludE9mVmlldyIsImVuZ2luZSIsInB1ZyIsIlB1ZyIsImluY2x1ZGVWaWV3RXh0ZW5zaW9uIiwiZGVmYXVsdENvbnRleHQiLCJhc3NldFBhdGgiLCJmaWxlbmFtZSIsInNldFVwQXNzZXRzIiwiZmFzdGlmeVN0YXRpYyIsInJvb3QiLCJwYXRoIiwiam9pbiIsIl9fZGlybmFtZSIsInByZWZpeCIsIkZhc3RpZnkiLCJsb2dnZXIiLCJyZWdpc3RlclBsdWdpbnMiLCJmYXN0aWZ5Rm9ybWJvZHkiLCJmYXN0aWZ5T2JqZWN0aW9uIiwia25leENvbmZpZyIsImRldmVsb3BtZW50IiwibW9kZWxzIiwicm91dGVzIiwibGlzdGVuIiwiUE9SVCIsImVyciIsImFkZHJlc3MiLCJlcnJvciIsImV4aXQiLCJpbmZvIl0sIm1hcHBpbmdzIjoiOztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBOztBQUNBOzs7O0FBRUFBLGdCQUFPQyxNQUFQOztBQUVBLE1BQU1DLE9BQU8sR0FBRyxJQUFJQyxnQkFBSixDQUFZO0FBQzFCQyxFQUFBQSxXQUFXLEVBQUVDLE9BQU8sQ0FBQ0MsR0FBUixDQUFZQyw2QkFEQztBQUUxQkMsRUFBQUEsZUFBZSxFQUFFLElBRlM7QUFHMUJDLEVBQUFBLDBCQUEwQixFQUFFO0FBSEYsQ0FBWixDQUFoQixDLENBTUE7O0FBRUFQLE9BQU8sQ0FBQ1EsR0FBUixDQUFZLGNBQVo7O0FBRUEsTUFBTUMsVUFBVSxHQUFJQyxHQUFELElBQVM7QUFDMUJBLEVBQUFBLEdBQUcsQ0FBQ0MsUUFBSixDQUFhQyxvQkFBYixFQUEwQjtBQUN4QkMsSUFBQUEsTUFBTSxFQUFFO0FBQ05DLE1BQUFBLEdBQUcsRUFBRUM7QUFEQyxLQURnQjtBQUl4QkMsSUFBQUEsb0JBQW9CLEVBQUUsSUFKRTtBQUt4QkMsSUFBQUEsY0FBYyxFQUFFO0FBQ2RDLE1BQUFBLFNBQVMsRUFBR0MsUUFBRCxJQUFlLFdBQVVBLFFBQVM7QUFEL0I7QUFMUSxHQUExQjtBQVNELENBVkQ7O0FBWUEsTUFBTUMsV0FBVyxHQUFJVixHQUFELElBQVM7QUFDM0JBLEVBQUFBLEdBQUcsQ0FBQ0MsUUFBSixDQUFhVSxzQkFBYixFQUE0QjtBQUMxQkMsSUFBQUEsSUFBSSxFQUFFQyxjQUFLQyxJQUFMLENBQVVDLFNBQVYsRUFBcUIsSUFBckIsRUFBMkIsUUFBM0IsQ0FEb0I7QUFFMUJDLElBQUFBLE1BQU0sRUFBRTtBQUZrQixHQUE1QjtBQUlELENBTEQ7O0FBT0EsTUFBTWhCLEdBQUcsR0FBRyxJQUFJaUIsZ0JBQUosQ0FBWTtBQUN0QkMsRUFBQUEsTUFBTSxFQUFFO0FBRGMsQ0FBWixDQUFaOztBQUlBLE1BQU1DLGVBQWUsR0FBSW5CLEdBQUQsSUFBUztBQUMvQkEsRUFBQUEsR0FBRyxDQUFDQyxRQUFKLENBQWFtQix3QkFBYjtBQUNBckIsRUFBQUEsVUFBVSxDQUFDQyxHQUFELENBQVY7QUFDQVUsRUFBQUEsV0FBVyxDQUFDVixHQUFELENBQVg7QUFDQUEsRUFBQUEsR0FBRyxDQUFDQyxRQUFKLENBQWFvQiwyQkFBYixFQUErQjtBQUM3QkMsSUFBQUEsVUFBVSxFQUFFQSxrQkFBV0MsV0FETTtBQUU3QkMsSUFBQUEsTUFBTSxFQUFOQTtBQUY2QixHQUEvQjtBQUlBeEIsRUFBQUEsR0FBRyxDQUFDQyxRQUFKLENBQWF3QixjQUFiO0FBQ0QsQ0FURDs7QUFXQU4sZUFBZSxDQUFDbkIsR0FBRCxDQUFmO0FBRUFBLEdBQUcsQ0FBQzBCLE1BQUosQ0FBV2pDLE9BQU8sQ0FBQ0MsR0FBUixDQUFZaUMsSUFBWixJQUFvQixJQUEvQixFQUFxQyxTQUFyQyxFQUFnRCxDQUFDQyxHQUFELEVBQU1DLE9BQU4sS0FBa0I7QUFDaEUsTUFBSUQsR0FBSixFQUFTO0FBQ1A1QixJQUFBQSxHQUFHLENBQUNGLEdBQUosQ0FBUWdDLEtBQVIsQ0FBY0YsR0FBZDtBQUNBbkMsSUFBQUEsT0FBTyxDQUFDc0MsSUFBUixDQUFhLENBQWI7QUFDRDs7QUFDRC9CLEVBQUFBLEdBQUcsQ0FBQ0YsR0FBSixDQUFRa0MsSUFBUixDQUFjLHVCQUFzQkgsT0FBUSxFQUE1QztBQUNELENBTkQiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgRmFzdGlmeSBmcm9tICdmYXN0aWZ5JztcbmltcG9ydCBSb2xsYmFyIGZyb20gJ3JvbGxiYXInO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgZG90ZW52IGZyb20gJ2RvdGVudic7XG5pbXBvcnQgUHVnIGZyb20gJ3B1Zyc7XG5pbXBvcnQgZmFzdGlmeVN0YXRpYyBmcm9tICdmYXN0aWZ5LXN0YXRpYyc7XG5pbXBvcnQgZmFzdGlmeUZvcm1ib2R5IGZyb20gJ2Zhc3RpZnktZm9ybWJvZHknO1xuaW1wb3J0IGZhc3RpZnlPYmplY3Rpb24gZnJvbSAnZmFzdGlmeS1vYmplY3Rpb25qcyc7XG5pbXBvcnQgcG9pbnRPZlZpZXcgZnJvbSAncG9pbnQtb2Ytdmlldyc7XG5pbXBvcnQgbW9kZWxzIGZyb20gJy4vbW9kZWxzJztcblxuaW1wb3J0IGtuZXhDb25maWcgZnJvbSAnLi4va25leGZpbGUuanMnO1xuaW1wb3J0IHJvdXRlcyBmcm9tICcuL3JvdXRlcy9pbmRleC5qcyc7XG5cbmRvdGVudi5jb25maWcoKTtcblxuY29uc3Qgcm9sbGJhciA9IG5ldyBSb2xsYmFyKHtcbiAgYWNjZXNzVG9rZW46IHByb2Nlc3MuZW52LlBPU1RfU0VSVkVSX0lURU1fQUNDRVNTX1RPS0VOLFxuICBjYXB0dXJlVW5jYXVnaHQ6IHRydWUsXG4gIGNhcHR1cmVVbmhhbmRsZWRSZWplY3Rpb25zOiB0cnVlLFxufSk7XG5cbi8vICBhcHAudXNlKHJvbGxiYXIuZXJyb3JIYW5kbGVyKCkpO1xuXG5yb2xsYmFyLmxvZygnSGVsbG8gd29ybGQhJyk7XG5cbmNvbnN0IHNldFVwVmlld3MgPSAoYXBwKSA9PiB7XG4gIGFwcC5yZWdpc3Rlcihwb2ludE9mVmlldywge1xuICAgIGVuZ2luZToge1xuICAgICAgcHVnOiBQdWcsXG4gICAgfSxcbiAgICBpbmNsdWRlVmlld0V4dGVuc2lvbjogdHJ1ZSxcbiAgICBkZWZhdWx0Q29udGV4dDoge1xuICAgICAgYXNzZXRQYXRoOiAoZmlsZW5hbWUpID0+IGAvYXNzZXRzLyR7ZmlsZW5hbWV9YCxcbiAgICB9LFxuICB9KTtcbn07XG5cbmNvbnN0IHNldFVwQXNzZXRzID0gKGFwcCkgPT4ge1xuICBhcHAucmVnaXN0ZXIoZmFzdGlmeVN0YXRpYywge1xuICAgIHJvb3Q6IHBhdGguam9pbihfX2Rpcm5hbWUsICcuLicsICdwdWJsaWMnKSxcbiAgICBwcmVmaXg6ICcvYXNzZXRzLycsXG4gIH0pO1xufTtcblxuY29uc3QgYXBwID0gbmV3IEZhc3RpZnkoe1xuICBsb2dnZXI6IHRydWUsXG59KTtcblxuY29uc3QgcmVnaXN0ZXJQbHVnaW5zID0gKGFwcCkgPT4ge1xuICBhcHAucmVnaXN0ZXIoZmFzdGlmeUZvcm1ib2R5KTtcbiAgc2V0VXBWaWV3cyhhcHApO1xuICBzZXRVcEFzc2V0cyhhcHApO1xuICBhcHAucmVnaXN0ZXIoZmFzdGlmeU9iamVjdGlvbiwge1xuICAgIGtuZXhDb25maWc6IGtuZXhDb25maWcuZGV2ZWxvcG1lbnQsXG4gICAgbW9kZWxzLFxuICB9KTtcbiAgYXBwLnJlZ2lzdGVyKHJvdXRlcyk7XG59O1xuXG5yZWdpc3RlclBsdWdpbnMoYXBwKTtcblxuYXBwLmxpc3Rlbihwcm9jZXNzLmVudi5QT1JUIHx8IDMwMDAsICcwLjAuMC4wJywgKGVyciwgYWRkcmVzcykgPT4ge1xuICBpZiAoZXJyKSB7XG4gICAgYXBwLmxvZy5lcnJvcihlcnIpO1xuICAgIHByb2Nlc3MuZXhpdCgxKTtcbiAgfVxuICBhcHAubG9nLmluZm8oYHNlcnZlciBsaXN0ZW5pbmcgb24gJHthZGRyZXNzfWApO1xufSk7XG4iXX0=